{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "definitions": {
    "ConversationTurn": {
      "description": "A single turn in a conversation (for context tracking)",
      "properties": {
        "content": {
          "description": "Content of the message",
          "type": "string"
        },
        "role": {
          "description": "Role of the speaker (user, assistant, system)",
          "type": "string"
        },
        "speaker": {
          "default": null,
          "description": "Optional speaker identifier (for multi-agent)",
          "type": [
            "string",
            "null"
          ]
        },
        "timestamp": {
          "default": null,
          "description": "Timestamp of the turn",
          "type": [
            "string",
            "null"
          ]
        }
      },
      "required": [
        "content",
        "role"
      ],
      "type": "object"
    },
    "RequestContext": {
      "description": "HTTP request context for audit/logging\n\nCaptures metadata about the HTTP request that triggered an action. Used for security auditing, rate limiting, and debugging.\n\n## Usage\n\nEmbed in types that need request tracking: ```rust,ignore pub struct AuditLogEntry { // ... other fields #[serde(flatten)] pub request_context: RequestContext, } ```\n\n## Fields Replaced\n\nThis component replaces the common pattern of: - `pub ip_address: Option<String>` - `pub user_agent: Option<String>`",
      "properties": {
        "ip_address": {
          "description": "Client IP address (may be from X-Forwarded-For in proxied environments)",
          "type": [
            "string",
            "null"
          ]
        },
        "user_agent": {
          "description": "Client User-Agent header",
          "type": [
            "string",
            "null"
          ]
        }
      },
      "type": "object"
    },
    "SignupConsents": {
      "description": "Consent flags for signup",
      "properties": {
        "ai_processing": {
          "type": [
            "boolean",
            "null"
          ]
        },
        "marketing": {
          "type": [
            "boolean",
            "null"
          ]
        },
        "privacy": {
          "type": "boolean"
        },
        "terms": {
          "type": "boolean"
        }
      },
      "required": [
        "privacy",
        "terms"
      ],
      "type": "object"
    },
    "WeaveBlock": {
      "description": "Input block types for multimodal weave requests",
      "oneOf": [
        {
          "properties": {
            "content": {
              "type": "string"
            },
            "type": {
              "enum": [
                "text"
              ],
              "type": "string"
            }
          },
          "required": [
            "content",
            "type"
          ],
          "type": "object"
        },
        {
          "properties": {
            "alt_text": {
              "type": [
                "string",
                "null"
              ]
            },
            "analyze": {
              "default": true,
              "description": "Request vision analysis",
              "type": "boolean"
            },
            "source": {
              "description": "base64 data URI or URL",
              "type": "string"
            },
            "type": {
              "enum": [
                "image"
              ],
              "type": "string"
            }
          },
          "required": [
            "source",
            "type"
          ],
          "type": "object"
        },
        {
          "properties": {
            "duration_secs": {
              "format": "double",
              "type": [
                "number",
                "null"
              ]
            },
            "source": {
              "type": "string"
            },
            "transcript": {
              "description": "Pre-transcribed (skip Whisper)",
              "type": [
                "string",
                "null"
              ]
            },
            "type": {
              "enum": [
                "audio"
              ],
              "type": "string"
            }
          },
          "required": [
            "source",
            "type"
          ],
          "type": "object"
        },
        {
          "properties": {
            "filename": {
              "type": [
                "string",
                "null"
              ]
            },
            "mime_type": {
              "type": [
                "string",
                "null"
              ]
            },
            "source": {
              "type": "string"
            },
            "type": {
              "enum": [
                "document"
              ],
              "type": "string"
            }
          },
          "required": [
            "source",
            "type"
          ],
          "type": "object"
        },
        {
          "properties": {
            "extract_images": {
              "default": false,
              "description": "Whether to extract images from the page",
              "type": "boolean"
            },
            "selector": {
              "description": "Optional CSS selector to extract specific content",
              "type": [
                "string",
                "null"
              ]
            },
            "type": {
              "enum": [
                "webpage"
              ],
              "type": "string"
            },
            "url": {
              "description": "URL to scrape",
              "type": "string"
            }
          },
          "required": [
            "type",
            "url"
          ],
          "type": "object"
        }
      ]
    }
  },
  "description": "All commands in the system - unified enum across domains\n\nFollowing the single-envelope pattern, all command types are variants of this single enum. The worker routes based on variant type.",
  "oneOf": [
    {
      "description": "Start a new course from a weave",
      "properties": {
        "blocks": {
          "description": "Multimodal blocks (images, audio, etc.)",
          "items": {
            "$ref": "#/definitions/WeaveBlock"
          },
          "type": [
            "array",
            "null"
          ]
        },
        "content": {
          "description": "Raw text content",
          "type": "string"
        },
        "context": {
          "description": "Optional context",
          "type": [
            "string",
            "null"
          ]
        },
        "conversation_history": {
          "default": [],
          "description": "Prior conversation for context",
          "items": {
            "$ref": "#/definitions/ConversationTurn"
          },
          "type": "array"
        },
        "type": {
          "enum": [
            "course_start"
          ],
          "type": "string"
        },
        "weave_id": {
          "description": "The weave (user input) ID",
          "format": "uuid",
          "type": "string"
        }
      },
      "required": [
        "content",
        "type",
        "weave_id"
      ],
      "type": "object"
    },
    {
      "description": "Continue an existing course with additional user input",
      "properties": {
        "blocks": {
          "description": "Optional multimodal blocks",
          "items": {
            "$ref": "#/definitions/WeaveBlock"
          },
          "type": [
            "array",
            "null"
          ]
        },
        "type": {
          "enum": [
            "course_continue"
          ],
          "type": "string"
        },
        "user_message": {
          "description": "The new user message",
          "type": "string"
        }
      },
      "required": [
        "type",
        "user_message"
      ],
      "type": "object"
    },
    {
      "description": "Cancel a running course",
      "properties": {
        "reason": {
          "description": "Reason for cancellation",
          "type": [
            "string",
            "null"
          ]
        },
        "type": {
          "enum": [
            "course_cancel"
          ],
          "type": "string"
        }
      },
      "required": [
        "type"
      ],
      "type": "object"
    },
    {
      "description": "Retry a failed course",
      "properties": {
        "original_command_id": {
          "description": "Original command to retry",
          "format": "uuid",
          "type": "string"
        },
        "type": {
          "enum": [
            "course_retry"
          ],
          "type": "string"
        }
      },
      "required": [
        "original_command_id",
        "type"
      ],
      "type": "object"
    },
    {
      "description": "User signup request",
      "properties": {
        "consents": {
          "allOf": [
            {
              "$ref": "#/definitions/SignupConsents"
            }
          ],
          "description": "User consent flags"
        },
        "email": {
          "description": "User's email address",
          "type": "string"
        },
        "invite_code": {
          "description": "Invite code if signing up via invitation",
          "type": [
            "string",
            "null"
          ]
        },
        "name": {
          "description": "User's display name",
          "type": "string"
        },
        "password": {
          "description": "User's password (will be hashed by worker)",
          "type": "string"
        },
        "request_context": {
          "anyOf": [
            {
              "$ref": "#/definitions/RequestContext"
            },
            {
              "type": "null"
            }
          ],
          "description": "Request context for audit"
        },
        "type": {
          "enum": [
            "signup"
          ],
          "type": "string"
        }
      },
      "required": [
        "consents",
        "email",
        "name",
        "password",
        "type"
      ],
      "type": "object"
    },
    {
      "description": "Create a new family/tenant",
      "properties": {
        "family_name": {
          "description": "Name for the new family",
          "type": "string"
        },
        "type": {
          "enum": [
            "create_family"
          ],
          "type": "string"
        }
      },
      "required": [
        "family_name",
        "type"
      ],
      "type": "object"
    },
    {
      "description": "Accept an invitation to join a family",
      "properties": {
        "invitation_code": {
          "description": "The invitation code to accept",
          "type": "string"
        },
        "type": {
          "enum": [
            "accept_invitation"
          ],
          "type": "string"
        }
      },
      "required": [
        "invitation_code",
        "type"
      ],
      "type": "object"
    }
  ],
  "title": "Command"
}