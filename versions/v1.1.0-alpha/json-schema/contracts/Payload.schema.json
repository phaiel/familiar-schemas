{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "definitions": {
    "RequestContext": {
      "description": "Request context for audit logging",
      "properties": {
        "ip_address": {
          "description": "Client IP address (may be behind proxy)",
          "type": [
            "string",
            "null"
          ]
        },
        "request_id": {
          "description": "Request ID for correlation",
          "type": [
            "string",
            "null"
          ]
        },
        "user_agent": {
          "description": "User agent string",
          "type": [
            "string",
            "null"
          ]
        }
      },
      "type": "object"
    },
    "SignupConsents": {
      "description": "User consent flags for signup",
      "properties": {
        "privacy": {
          "description": "User accepted privacy policy",
          "type": "boolean"
        },
        "terms": {
          "description": "User accepted terms of service",
          "type": "boolean"
        }
      },
      "required": [
        "privacy",
        "terms"
      ],
      "type": "object"
    },
    "TraceKind": {
      "description": "Type of trace event",
      "oneOf": [
        {
          "description": "Overall workflow step",
          "enum": [
            "step"
          ],
          "type": "string"
        },
        {
          "description": "Agent thinking/reasoning",
          "enum": [
            "thought"
          ],
          "type": "string"
        },
        {
          "description": "Tool invocation",
          "enum": [
            "tool"
          ],
          "type": "string"
        },
        {
          "description": "Response token stream",
          "enum": [
            "token"
          ],
          "type": "string"
        },
        {
          "description": "Error occurred",
          "enum": [
            "error"
          ],
          "type": "string"
        },
        {
          "description": "Metric/timing data",
          "enum": [
            "metric"
          ],
          "type": "string"
        }
      ]
    },
    "TraceStatus": {
      "description": "Status of a trace unit",
      "oneOf": [
        {
          "description": "Step started",
          "enum": [
            "started"
          ],
          "type": "string"
        },
        {
          "description": "Step in progress (for long-running)",
          "enum": [
            "in_progress"
          ],
          "type": "string"
        },
        {
          "description": "Step completed successfully",
          "enum": [
            "completed"
          ],
          "type": "string"
        },
        {
          "description": "Step failed",
          "enum": [
            "failed"
          ],
          "type": "string"
        },
        {
          "description": "Step was cancelled",
          "enum": [
            "cancelled"
          ],
          "type": "string"
        }
      ]
    }
  },
  "description": "Discriminated union of all payload types\n\nThis enum contains ALL message types in the system. The `type` tag distinguishes between different payloads, enabling routing without deserializing the full message.\n\n## Naming Convention\n\n- Commands: verb form (e.g., `CourseStart`, `Signup`) - Events: past tense (e.g., `CourseStarted`, `SignupCompleted`) - Traces: special `Trace` variant with sub-typing",
  "oneOf": [
    {
      "description": "Start a new course from a weave",
      "properties": {
        "blocks": {
          "description": "Multimodal blocks (images, audio, etc.)",
          "items": true,
          "type": [
            "array",
            "null"
          ]
        },
        "content": {
          "description": "Raw text content",
          "type": "string"
        },
        "context": {
          "description": "Optional context",
          "type": [
            "string",
            "null"
          ]
        },
        "conversation_history": {
          "default": [],
          "description": "Prior conversation for context",
          "items": true,
          "type": "array"
        },
        "type": {
          "enum": [
            "course_start"
          ],
          "type": "string"
        },
        "weave_id": {
          "description": "The weave (user input) ID",
          "format": "uuid",
          "type": "string"
        }
      },
      "required": [
        "content",
        "type",
        "weave_id"
      ],
      "type": "object"
    },
    {
      "description": "Continue an existing course with additional user input",
      "properties": {
        "blocks": {
          "description": "Optional multimodal blocks",
          "items": true,
          "type": [
            "array",
            "null"
          ]
        },
        "type": {
          "enum": [
            "course_continue"
          ],
          "type": "string"
        },
        "user_message": {
          "description": "The new user message",
          "type": "string"
        }
      },
      "required": [
        "type",
        "user_message"
      ],
      "type": "object"
    },
    {
      "description": "Cancel a running course",
      "properties": {
        "reason": {
          "description": "Reason for cancellation",
          "type": [
            "string",
            "null"
          ]
        },
        "type": {
          "enum": [
            "course_cancel"
          ],
          "type": "string"
        }
      },
      "required": [
        "type"
      ],
      "type": "object"
    },
    {
      "description": "Retry a failed course",
      "properties": {
        "original_command_id": {
          "description": "Original command to retry",
          "format": "uuid",
          "type": "string"
        },
        "type": {
          "enum": [
            "course_retry"
          ],
          "type": "string"
        }
      },
      "required": [
        "original_command_id",
        "type"
      ],
      "type": "object"
    },
    {
      "description": "Course has started processing",
      "properties": {
        "type": {
          "enum": [
            "course_started"
          ],
          "type": "string"
        },
        "weave_id": {
          "description": "The weave that started this course",
          "format": "uuid",
          "type": "string"
        }
      },
      "required": [
        "type",
        "weave_id"
      ],
      "type": "object"
    },
    {
      "description": "Segmentation phase completed",
      "properties": {
        "type": {
          "enum": [
            "course_segmented"
          ],
          "type": "string"
        },
        "unit_count": {
          "description": "Number of segments/units identified",
          "format": "uint",
          "minimum": 0.0,
          "type": "integer"
        }
      },
      "required": [
        "type",
        "unit_count"
      ],
      "type": "object"
    },
    {
      "description": "Classification phase completed",
      "properties": {
        "entity_types": {
          "description": "Entity types identified",
          "items": {
            "type": "string"
          },
          "type": "array"
        },
        "physics_summary": {
          "description": "Physics hints computed (optional)",
          "type": [
            "string",
            "null"
          ]
        },
        "type": {
          "enum": [
            "course_classified"
          ],
          "type": "string"
        }
      },
      "required": [
        "entity_types",
        "type"
      ],
      "type": "object"
    },
    {
      "description": "Course completed successfully",
      "properties": {
        "duration_ms": {
          "description": "Duration in milliseconds",
          "format": "uint64",
          "minimum": 0.0,
          "type": "integer"
        },
        "response": {
          "description": "The final response to send to user",
          "type": "string"
        },
        "tokens_used": {
          "description": "Token usage (if tracked)",
          "format": "uint32",
          "minimum": 0.0,
          "type": [
            "integer",
            "null"
          ]
        },
        "type": {
          "enum": [
            "course_completed"
          ],
          "type": "string"
        }
      },
      "required": [
        "duration_ms",
        "response",
        "type"
      ],
      "type": "object"
    },
    {
      "description": "Course failed",
      "properties": {
        "error": {
          "description": "Error message (sanitized for storage)",
          "type": "string"
        },
        "error_code": {
          "description": "Error code for programmatic handling",
          "type": [
            "string",
            "null"
          ]
        },
        "retryable": {
          "default": false,
          "description": "Whether this is retryable",
          "type": "boolean"
        },
        "type": {
          "enum": [
            "course_failed"
          ],
          "type": "string"
        }
      },
      "required": [
        "error",
        "type"
      ],
      "type": "object"
    },
    {
      "description": "Course was cancelled",
      "properties": {
        "cancelled_by": {
          "description": "Who cancelled (user, system, timeout)",
          "type": "string"
        },
        "reason": {
          "description": "Reason for cancellation",
          "type": [
            "string",
            "null"
          ]
        },
        "type": {
          "enum": [
            "course_cancelled"
          ],
          "type": "string"
        }
      },
      "required": [
        "cancelled_by",
        "type"
      ],
      "type": "object"
    },
    {
      "description": "Course is being retried",
      "properties": {
        "attempt": {
          "description": "Retry attempt number",
          "format": "uint32",
          "minimum": 0.0,
          "type": "integer"
        },
        "original_error": {
          "description": "Original error that triggered retry",
          "type": "string"
        },
        "type": {
          "enum": [
            "course_retrying"
          ],
          "type": "string"
        }
      },
      "required": [
        "attempt",
        "original_error",
        "type"
      ],
      "type": "object"
    },
    {
      "description": "User signup request",
      "properties": {
        "consents": {
          "allOf": [
            {
              "$ref": "SignupConsents.schema.json"
            }
          ],
          "description": "User consent flags"
        },
        "email": {
          "description": "User's email address",
          "type": "string"
        },
        "invite_code": {
          "description": "Invite code if signing up via invitation",
          "type": [
            "string",
            "null"
          ]
        },
        "name": {
          "description": "User's display name",
          "type": "string"
        },
        "password": {
          "description": "User's password (will be hashed by worker)",
          "type": "string"
        },
        "request_context": {
          "anyOf": [
            {
              "$ref": "RequestContext.schema.json"
            },
            {
              "type": "null"
            }
          ],
          "description": "Request context for audit"
        },
        "type": {
          "enum": [
            "signup"
          ],
          "type": "string"
        }
      },
      "required": [
        "consents",
        "email",
        "name",
        "password",
        "type"
      ],
      "type": "object"
    },
    {
      "description": "Create a new family/tenant",
      "properties": {
        "family_name": {
          "description": "Name for the new family",
          "type": "string"
        },
        "type": {
          "enum": [
            "create_family"
          ],
          "type": "string"
        }
      },
      "required": [
        "family_name",
        "type"
      ],
      "type": "object"
    },
    {
      "description": "Accept an invitation to join a family",
      "properties": {
        "invitation_code": {
          "description": "The invitation code to accept",
          "type": "string"
        },
        "type": {
          "enum": [
            "accept_invitation"
          ],
          "type": "string"
        }
      },
      "required": [
        "invitation_code",
        "type"
      ],
      "type": "object"
    },
    {
      "description": "Signup completed successfully",
      "properties": {
        "needs_family": {
          "description": "Whether the user needs to create/join a family",
          "type": "boolean"
        },
        "session_token": {
          "description": "Session token for the new user",
          "type": "string"
        },
        "type": {
          "enum": [
            "signup_completed"
          ],
          "type": "string"
        }
      },
      "required": [
        "needs_family",
        "session_token",
        "type"
      ],
      "type": "object"
    },
    {
      "description": "Family creation completed",
      "properties": {
        "tenant_name": {
          "description": "Name of the created tenant",
          "type": "string"
        },
        "type": {
          "enum": [
            "family_created"
          ],
          "type": "string"
        }
      },
      "required": [
        "tenant_name",
        "type"
      ],
      "type": "object"
    },
    {
      "description": "Invitation accepted",
      "properties": {
        "family_name": {
          "description": "Name of the family joined",
          "type": "string"
        },
        "type": {
          "enum": [
            "invitation_accepted"
          ],
          "type": "string"
        }
      },
      "required": [
        "family_name",
        "type"
      ],
      "type": "object"
    },
    {
      "description": "Onboarding failed",
      "properties": {
        "error_code": {
          "description": "Error code for programmatic handling",
          "type": "string"
        },
        "message": {
          "description": "Human-readable error message",
          "type": "string"
        },
        "type": {
          "enum": [
            "onboarding_failed"
          ],
          "type": "string"
        }
      },
      "required": [
        "error_code",
        "message",
        "type"
      ],
      "type": "object"
    },
    {
      "description": "Trace event for UI streaming",
      "properties": {
        "agent": {
          "description": "Agent that produced this trace",
          "type": [
            "string",
            "null"
          ]
        },
        "duration_ms": {
          "description": "Duration in milliseconds",
          "format": "uint64",
          "minimum": 0.0,
          "type": [
            "integer",
            "null"
          ]
        },
        "kind": {
          "allOf": [
            {
              "$ref": "TraceKind.schema.json"
            }
          ],
          "description": "Type of trace"
        },
        "message": {
          "description": "Human-readable message",
          "type": "string"
        },
        "parent_span_id": {
          "description": "Parent span (for hierarchy)",
          "type": [
            "string",
            "null"
          ]
        },
        "seq": {
          "description": "Monotonic sequence number per-course",
          "format": "uint64",
          "minimum": 0.0,
          "type": "integer"
        },
        "span_id": {
          "description": "Span identifier",
          "type": "string"
        },
        "status": {
          "allOf": [
            {
              "$ref": "TraceStatus.schema.json"
            }
          ],
          "description": "Status of this trace unit"
        },
        "tokens": {
          "description": "Response tokens (if kind == Token)",
          "type": [
            "string",
            "null"
          ]
        },
        "tool_args": {
          "description": "Tool arguments (redacted/summarized)"
        },
        "tool_name": {
          "description": "Tool name (if kind == Tool)",
          "type": [
            "string",
            "null"
          ]
        },
        "tool_result": {
          "description": "Tool result (summary only)",
          "type": [
            "string",
            "null"
          ]
        },
        "type": {
          "enum": [
            "trace"
          ],
          "type": "string"
        }
      },
      "required": [
        "kind",
        "message",
        "seq",
        "span_id",
        "status",
        "type"
      ],
      "type": "object"
    }
  ],
  "title": "Payload",
  "x-familiar-casing": "snake_case",
  "x-familiar-discriminator": "type",
  "x-familiar-enum-repr": "internally_tagged",
  "x-familiar-kind": "contract",
  "x-familiar-service": {
    "$ref": "../nodes/familiar-worker.node.json"
  },
  "x-familiar-variants": {
    "accept_invitation": "AcceptInvitation",
    "course_cancel": "CourseCancel",
    "course_cancelled": "CourseCancelled",
    "course_classified": "CourseClassified",
    "course_completed": "CourseCompleted",
    "course_continue": "CourseContinue",
    "course_failed": "CourseFailed",
    "course_retry": "CourseRetry",
    "course_retrying": "CourseRetrying",
    "course_segmented": "CourseSegmented",
    "course_start": "CourseStart",
    "course_started": "CourseStarted",
    "create_family": "CreateFamily",
    "family_created": "FamilyCreated",
    "invitation_accepted": "InvitationAccepted",
    "onboarding_failed": "OnboardingFailed",
    "signup": "Signup",
    "signup_completed": "SignupCompleted",
    "trace": "Trace"
  }
}
