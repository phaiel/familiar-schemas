{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://familiar.dev/schemas/ecs/Technique.meta.schema.json",
  "title": "Technique Definition (ISA)",
  "description": "A constrained workflow using exactly 5 step types: call, switch, map, parallel, transform.",
  "type": "object",
  "required": ["id", "x-familiar-kind", "input", "output", "steps"],
  "properties": {
    "id": { "type": "string" },
    "title": { "type": "string" },
    "description": { "type": "string" },

    "x-familiar-kind": { "const": "technique" },

    "input": {
      "description": "The input contract for this entire flow.",
      "type": "object",
      "properties": { "$ref": { "type": "string" } },
      "required": ["$ref"]
    },

    "output": {
      "description": "The return type of this flow.",
      "type": "object",
      "properties": { "$ref": { "type": "string" } },
      "required": ["$ref"]
    },

    "steps": {
      "type": "array",
      "description": "Constrained instruction set: call, switch, map, parallel, transform",
      "items": { "$ref": "#/definitions/Step" }
    },

    "return": {
      "type": "object",
      "description": "Final output construction using CEL expressions",
      "additionalProperties": true
    }
  },

  "definitions": {
    "SchemaRef": {
      "type": "object",
      "properties": { "$ref": { "type": "string" } },
      "required": ["$ref"]
    },

    "Step": {
      "type": "object",
      "required": ["id", "kind"],
      "properties": {
        "id": {
          "type": "string",
          "pattern": "^[a-z_][a-z0-9_]*$",
          "description": "Unique identifier for this step variable (snake_case)."
        },
        "description": { "type": "string" },
        "x-familiar-visual": {
          "type": "object",
          "description": "Visual layout coordinates for flow diagrams",
          "properties": {
            "x": {"type": "number"},
            "y": {"type": "number"}
          }
        }
      },
      "oneOf": [
        { "$ref": "#/definitions/CallStep" },
        { "$ref": "#/definitions/SwitchStep" },
        { "$ref": "#/definitions/MapStep" },
        { "$ref": "#/definitions/ParallelStep" },
        { "$ref": "#/definitions/TransformStep" }
      ]
    },

    "CallStep": {
      "properties": {
        "kind": { "const": "call" },
        "action": { "$ref": "#/definitions/SchemaRef", "description": "Action to execute" },
        "args": {
          "type": "object",
          "description": "Argument mapping using CEL expressions",
          "additionalProperties": { "type": "string" }
        },
        "retry": {
          "type": "object",
          "properties": { "max_attempts": { "type": "integer", "default": 3 } }
        },
        "timeout": { "type": "string", "description": "ISO 8601 duration" }
      },
      "required": ["action"]
    },

    "SwitchStep": {
      "properties": {
        "kind": { "const": "switch" },
        "branches": {
          "type": "array",
          "items": {
            "type": "object",
            "required": ["condition", "steps"],
            "properties": {
              "condition": { "type": "string", "description": "CEL expression for branching" },
              "steps": { "type": "array", "items": { "$ref": "#/definitions/Step" } }
            }
          }
        },
        "default": {
          "type": "array",
          "items": { "$ref": "#/definitions/Step" },
          "description": "Steps to execute if no branches match"
        }
      },
      "required": ["branches"]
    },

    "MapStep": {
      "properties": {
        "kind": { "const": "map" },
        "items": {
          "type": "string",
          "description": "CEL expression evaluating to array to iterate over"
        },
        "iterator": {
          "type": "string",
          "description": "Variable name for current item in iteration",
          "default": "item"
        },
        "concurrency": { "type": "integer", "default": 5, "minimum": 1 },
        "steps": {
          "type": "array",
          "items": { "$ref": "#/definitions/Step" }
        }
      },
      "required": ["items", "steps"]
    },

    "ParallelStep": {
      "properties": {
        "kind": { "const": "parallel" },
        "branches": {
          "type": "object",
          "description": "Named branches executing concurrently",
          "patternProperties": {
            "^[a-zA-Z_][a-zA-Z0-9_]*$": {
              "type": "array",
              "items": { "$ref": "#/definitions/Step" }
            }
          }
        }
      },
      "required": ["branches"]
    },

    "TransformStep": {
      "properties": {
        "kind": { "const": "transform" },
        "output": {
          "type": "object",
          "description": "Output object constructed using CEL expressions",
          "additionalProperties": true
        }
      },
      "required": ["output"]
    }
  }
}
