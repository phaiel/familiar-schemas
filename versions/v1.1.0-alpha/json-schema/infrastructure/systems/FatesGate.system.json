{
  "$schema": "../../architecture/meta/System.meta.schema.json",
  "$id": "infrastructure/systems/FatesGate.system.json",
  "id": "fates-gate",
  "title": "Fates Gate",
  "description": "Entry point to the Fates pipeline with intelligent routing based on input characteristics",
  "x-familiar-kind": "system",

  "dispatch": [
    {
      "trigger": "kafka:commands.weave",
      "input_key": "weave_request",
      "technique": { "$ref": "../../techniques/ingest_weave.technique.json" },
      "routing_policy": "input.content_length > 10000 ? 'high-memory-pool' : 'standard-pool'",
      "output": {
        "schema": { "$ref": "../../entities/WeaveResult.schema.json" },
        "queue": { "$ref": "../queues/daemon-queue.queue.json" }
      },
      "constraints": {
        "timeout": "config:systems.fates_gate.timeouts.weave",
        "retries": "config:systems.fates_gate.retries.weave",
        "priority": "input.user_tier == 'premium' ? 'high' : 'normal'"
      }
    },
    {
      "trigger": "kafka:commands.search",
      "input_key": "search_request",
      "technique": { "$ref": "../../techniques/search_memory.technique.json" },
      "routing_policy": "input.complexity > 0.8 ? 'gpu-pool' : 'cpu-pool'",
      "output": {
        "schema": { "$ref": "../../entities/SearchResults.schema.json" },
        "queue": { "$ref": "../queues/daemon-queue.queue.json" }
      },
      "constraints": {
        "timeout": "config:systems.fates_gate.timeouts.search",
        "retries": "config:systems.fates_gate.retries.search"
      }
    },
    {
      "trigger": "kafka:commands.classify",
      "input_key": "classify_request",
      "technique": { "$ref": "../../techniques/classification/classify-input.technique.json" },
      "routing_policy": "'ml-pool'",
      "output": {
        "schema": { "$ref": "../../primitives/SegmentFeatures.schema.json" },
        "queue": { "$ref": "../queues/classifier-queue.queue.json" }
      },
      "constraints": {
        "timeout": "config:systems.fates_gate.timeouts.classify",
        "retries": "config:systems.fates_gate.retries.classify"
      }
    }
  ],

  "inputs": {
    "weave_request": { "$ref": "../../domains/windmill/ConciergeInput.schema.json" },
    "search_request": { "$ref": "../../entities_api/WeaveRequest.schema.json" },
    "classify_request": { "$ref": "../../primitives/Segment.schema.json" }
  },

  "output": {
    "schema": { "$ref": "../../primitives/SegmentFeatures.schema.json" },
    "queue": { "$ref": "../queues/daemon-queue.queue.json" }
  },

  "default_node": { "$ref": "../nodes/familiar-daemon.node.json" },
  "default_queue": { "$ref": "../queues/daemon-queue.queue.json" },

  "x-familiar-pgo": {
    "enabled": true,
    "priority": "high",
    "optimization_goal": "latency",
    "workload_samples": [
      { "$ref": "../../samples/fates/standard_weave.json" },
      { "$ref": "../../samples/fates/large_payload.json" },
      { "$ref": "../../samples/fates/complex_search.json" }
    ]
  }
}