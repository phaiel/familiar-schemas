{
  "$schema": "../../architecture/meta/System.meta.schema.json",
  "$id": "infrastructure/systems/FatesGate.system.json",
  "id": "fates-gate",
  "title": "Fates Gate",
  "description": "Entry point to the Fates pipeline with intelligent routing based on input characteristics",
  "x-familiar-kind": "system",

  "dispatch": [
    {
      "trigger": "kafka:commands.weave",
      "technique": { "$ref": "../../techniques/ingest_weave.technique.json" },
      "routing_policy": "input.content_length > 10000 ? 'high-memory-pool' : 'standard-pool'",
      "constraints": {
        "timeout": "30s",
        "retries": 3,
        "priority": "input.user_tier == 'premium' ? 'high' : 'normal'"
      }
    },
    {
      "trigger": "kafka:commands.search",
      "technique": { "$ref": "../../techniques/search_memory.technique.json" },
      "routing_policy": "input.complexity > 0.8 ? 'gpu-pool' : 'cpu-pool'",
      "constraints": {
        "timeout": "60s",
        "retries": 2
      }
    },
    {
      "trigger": "kafka:commands.classify",
      "technique": { "$ref": "../../techniques/classification/classify-input.technique.json" },
      "routing_policy": "'ml-pool'",
      "constraints": {
        "timeout": "120s",
        "retries": 1
      }
    }
  ],

  "inputs": {
    "weave_request": {
      "schema": { "$ref": "../../domains/windmill/ConciergeInput.schema.json" },
      "queue": { "$ref": "../queues/daemon-queue.queue.json" }
    },
    "search_request": {
      "schema": { "$ref": "../../entities_api/WeaveRequest.schema.json" },
      "queue": { "$ref": "../queues/daemon-queue.queue.json" }
    },
    "classify_request": {
      "schema": { "$ref": "../../primitives/Segment.schema.json" },
      "queue": { "$ref": "../queues/classifier-queue.queue.json" }
    }
  },

  "output": {
    "schema": { "$ref": "../../primitives/SegmentFeatures.schema.json" },
    "queue": { "$ref": "../queues/daemon-queue.queue.json" }
  },

  "node": { "$ref": "../nodes/familiar-daemon.node.json" },
  "queue": { "$ref": "../queues/daemon-queue.queue.json" }
}