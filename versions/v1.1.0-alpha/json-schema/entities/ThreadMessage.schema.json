{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "definitions": {
    "AgentMessageType": {
      "description": "Agent message types for different response formats\n\nThe agentic system can produce various types of responses depending on what the agent is doing. This enum captures all possible message types.",
      "oneOf": [
        {
          "description": "A log message from the agent (debugging, status updates)",
          "properties": {
            "content": {
              "type": "string"
            },
            "level": {
              "$ref": "../agentic/LogLevel.schema.json"
            },
            "message_type": {
              "enum": [
                "log"
              ],
              "type": "string"
            }
          },
          "required": [
            "content",
            "level",
            "message_type"
          ],
          "type": "object"
        },
        {
          "description": "A question the agent is asking the user",
          "properties": {
            "message_type": {
              "enum": [
                "question"
              ],
              "type": "string"
            },
            "options": {
              "default": null,
              "items": {
                "type": "string"
              },
              "type": [
                "array",
                "null"
              ]
            },
            "prompt": {
              "type": "string"
            }
          },
          "required": [
            "message_type",
            "prompt"
          ],
          "type": "object"
        },
        {
          "description": "An insight derived by the agent",
          "properties": {
            "confidence": {
              "format": "double",
              "type": "number"
            },
            "domain": {
              "default": null,
              "type": [
                "string",
                "null"
              ]
            },
            "message_type": {
              "enum": [
                "insight"
              ],
              "type": "string"
            },
            "summary": {
              "type": "string"
            }
          },
          "required": [
            "confidence",
            "message_type",
            "summary"
          ],
          "type": "object"
        },
        {
          "description": "A detailed analysis result",
          "properties": {
            "domain": {
              "type": "string"
            },
            "findings": {
              "items": {
                "$ref": "../agentic/Finding.schema.json"
              },
              "type": "array"
            },
            "message_type": {
              "enum": [
                "analysis"
              ],
              "type": "string"
            }
          },
          "required": [
            "domain",
            "findings",
            "message_type"
          ],
          "type": "object"
        },
        {
          "description": "A command/action the agent wants to execute",
          "properties": {
            "action": {
              "type": "string"
            },
            "message_type": {
              "enum": [
                "command"
              ],
              "type": "string"
            },
            "parameters": true
          },
          "required": [
            "action",
            "message_type",
            "parameters"
          ],
          "type": "object"
        },
        {
          "description": "A simple text response",
          "properties": {
            "content": {
              "type": "string"
            },
            "message_type": {
              "enum": [
                "text"
              ],
              "type": "string"
            }
          },
          "required": [
            "content",
            "message_type"
          ],
          "type": "object"
        },
        {
          "description": "Progress update during long-running tasks",
          "properties": {
            "message": {
              "type": "string"
            },
            "message_type": {
              "enum": [
                "progress"
              ],
              "type": "string"
            },
            "percent_complete": {
              "default": null,
              "format": "double",
              "type": [
                "number",
                "null"
              ]
            }
          },
          "required": [
            "message",
            "message_type"
          ],
          "type": "object"
        }
      ]
    },
    "Finding": {
      "description": "A finding from an analysis agent",
      "properties": {
        "confidence": {
          "default": null,
          "description": "Confidence score (0.0 to 1.0)",
          "format": "double",
          "type": [
            "number",
            "null"
          ]
        },
        "description": {
          "description": "Detailed description",
          "type": "string"
        },
        "related_entities": {
          "default": [],
          "description": "Related entity IDs",
          "items": {
            "type": "string"
          },
          "type": "array"
        },
        "title": {
          "description": "Title or label of the finding",
          "type": "string"
        }
      },
      "required": [
        "description",
        "title"
      ],
      "type": "object"
    },
    "LogLevel": {
      "description": "Log level for agent log messages",
      "enum": [
        "debug",
        "info",
        "warning",
        "error"
      ],
      "type": "string"
    }
  },
  "description": "A single message within a conversation thread",
  "properties": {
    "agent_speaker": {
      "default": null,
      "description": "Which agent sent this message (if role is Assistant)",
      "type": [
        "string",
        "null"
      ]
    },
    "content": {
      "default": null,
      "description": "Text content of the message",
      "type": [
        "string",
        "null"
      ]
    },
    "id": {
      "$ref": "../primitives/ThreadId.schema.json"
    },
    "message_type": {
      "anyOf": [
        {
          "$ref": "../agentic/AgentMessageType.schema.json"
        },
        {
          "type": "null"
        }
      ],
      "default": null,
      "description": "Structured message type (for agent messages)"
    },
    "metadata": {
      "default": null,
      "description": "Optional metadata"
    },
    "role": {
      "allOf": [
        {
          "$ref": "../primitives/MessageRole.schema.json"
        }
      ],
      "description": "Role of the message sender"
    },
    "thread_id": {
      "$ref": "../primitives/ThreadId.schema.json"
    },
    "timestamp": {
      "description": "When the message was created",
      "format": "date-time",
      "type": "string"
    }
  },
  "required": [
    "id",
    "role",
    "thread_id",
    "timestamp"
  ],
  "title": "ThreadMessage",
  "type": "object",
  "x-familiar-kind": "entity",
  "x-familiar-meta-schema": {
    "$ref": "../ecs/Entity.meta.schema.json"
  },
  "x-familiar-persistence": {
    "profile": "postgres",
    "table": "thread_messages",
    "primary_key": "id",
    "indexes": [
      "thread_id",
      "created_at"
    ]
  },
  "x-familiar-service": {
    "$ref": "../nodes/familiar-daemon.node.json"
  }
}
