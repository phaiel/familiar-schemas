"// Payload types for Familiar Kafka messages\n// All payload variants are represented as a protobuf oneof\nsyntax = \"proto3\";\n\npackage familiar.kafka;\n\n// =============================================================================\n// Payload - Discriminated Union of All Message Types\n// =============================================================================\n\n// Universal payload message containing all possible payload variants\nmessage Payload {\n  oneof payload {\n    // Course Commands\n    CourseStart course_start = 1;\n    CourseContinue course_continue = 2;\n    CourseCancel course_cancel = 3;\n    CourseRetry course_retry = 4;\n\n    // Course Events\n    CourseStarted course_started = 10;\n    CourseSegmented course_segmented = 11;\n    CourseClassified course_classified = 12;\n    CourseCompleted course_completed = 13;\n    CourseFailed course_failed = 14;\n    CourseCancelled course_cancelled = 15;\n    CourseRetrying course_retrying = 16;\n\n    // Onboarding Commands\n    Signup signup = 20;\n    CreateFamily create_family = 21;\n    AcceptInvitation accept_invitation = 22;\n\n    // Onboarding Events\n    SignupCompleted signup_completed = 30;\n    FamilyCreated family_created = 31;\n    InvitationAccepted invitation_accepted = 32;\n    OnboardingFailed onboarding_failed = 33;\n\n    // Traces\n    Trace trace = 40;\n  }\n}\n\n// =============================================================================\n// Course Domain - Commands\n// =============================================================================\n\n// Start a new course from a weave\nmessage CourseStart {\n  // The weave (user input) ID\n  string weave_id = 1;\n  // Raw text content\n  string content = 2;\n  // Optional context\n  optional string context = 3;\n  // Multimodal blocks (images, audio, etc.) - stored as JSON string\n  optional string blocks_json = 4;\n  // Prior conversation for context - stored as JSON string\n  optional string conversation_history_json = 5;\n}\n\n// Continue an existing course with additional user input\nmessage CourseContinue {\n  // The new user message\n  string user_message = 1;\n  // Optional multimodal blocks - stored as JSON string\n  optional string blocks_json = 2;\n}\n\n// Cancel a running course\nmessage CourseCancel {\n  // Reason for cancellation\n  optional string reason = 1;\n}\n\n// Retry a failed course\nmessage CourseRetry {\n  // Original command to retry\n  string original_command_id = 1;\n}\n\n// =============================================================================\n// Course Domain - Events\n// =============================================================================\n\n// Course has started processing\nmessage CourseStarted {\n  // The weave that started this course\n  string weave_id = 1;\n}\n\n// Segmentation phase completed\nmessage CourseSegmented {\n  // Number of segments/units identified\n  uint32 unit_count = 1;\n}\n\n// Classification phase completed\nmessage CourseClassified {\n  // Entity types identified\n  repeated string entity_types = 1;\n  // Physics hints computed (optional)\n  optional string physics_summary = 2;\n}\n\n// Course completed successfully\nmessage CourseCompleted {\n  // The final response to send to user\n  string response = 1;\n  // Duration in milliseconds\n  uint64 duration_ms = 2;\n  // Token usage (if tracked)\n  optional uint32 tokens_used = 3;\n}\n\n// Course failed\nmessage CourseFailed {\n  // Error message (sanitized for storage)\n  string error = 1;\n  // Error code for programmatic handling\n  optional string error_code = 2;\n  // Whether this is retryable\n  bool retryable = 3;\n}\n\n// Course was cancelled\nmessage CourseCancelled {\n  // Who cancelled (user, system, timeout)\n  string cancelled_by = 1;\n  // Reason for cancellation\n  optional string reason = 2;\n}\n\n// Course is being retried\nmessage CourseRetrying {\n  // Retry attempt number\n  uint32 attempt = 1;\n  // Original error that triggered retry\n  string original_error = 2;\n}\n\n// =============================================================================\n// Onboarding Domain - Commands\n// =============================================================================\n\n// User signup request\nmessage Signup {\n  // User's email address\n  string email = 1;\n  // User's password (will be hashed by worker)\n  string password = 2;\n  // User's display name\n  string name = 3;\n  // User consent flags\n  SignupConsents consents = 4;\n  // Request context for audit\n  optional RequestContext request_context = 5;\n  // Invite code if signing up via invitation\n  optional string invite_code = 6;\n}\n\n// User consent flags for signup\nmessage SignupConsents {\n  bool terms = 1;\n  bool privacy = 2;\n}\n\n// Request context for audit\nmessage RequestContext {\n  optional string ip_address = 1;\n  optional string user_agent = 2;\n  optional string referrer = 3;\n}\n\n// Create a new family/tenant\nmessage CreateFamily {\n  // Name for the new family\n  string family_name = 1;\n}\n\n// Accept an invitation to join a family\nmessage AcceptInvitation {\n  // The invitation code to accept\n  string invitation_code = 1;\n}\n\n// =============================================================================\n// Onboarding Domain - Events\n// =============================================================================\n\n// Signup completed successfully\nmessage SignupCompleted {\n  // Session token for the new user\n  string session_token = 1;\n  // Whether the user needs to create/join a family\n  bool needs_family = 2;\n}\n\n// Family creation completed\nmessage FamilyCreated {\n  // Name of the created tenant\n  string tenant_name = 1;\n}\n\n// Invitation accepted\nmessage InvitationAccepted {\n  // Name of the family joined\n  string family_name = 1;\n}\n\n// Onboarding failed\nmessage OnboardingFailed {\n  // Error code for programmatic handling\n  string error_code = 1;\n  // Human-readable error message\n  string message = 2;\n}\n\n// =============================================================================\n// Trace - UI-Safe Progress Messages\n// =============================================================================\n\n// Trace event for UI streaming\nmessage Trace {\n  // Monotonic sequence number per-course\n  uint64 seq = 1;\n  // Span identifier\n  string span_id = 2;\n  // Parent span (for hierarchy)\n  optional string parent_span_id = 3;\n  // Type of trace\n  TraceKind kind = 4;\n  // Status of this trace unit\n  TraceStatus status = 5;\n  // Agent that produced this trace\n  optional string agent = 6;\n  // Human-readable message\n  string message = 7;\n  // Tool name (if kind == TOOL)\n  optional string tool_name = 8;\n  // Tool arguments (redacted/summarized) - stored as JSON string\n  optional string tool_args_json = 9;\n  // Tool result (summary only)\n  optional string tool_result = 10;\n  // Response tokens (if kind == TOKEN)\n  optional string tokens = 11;\n  // Duration in milliseconds\n  optional uint64 duration_ms = 12;\n}\n\n// Type of trace\nenum TraceKind {\n  TRACE_KIND_UNSPECIFIED = 0;\n  TRACE_KIND_STEP = 1;\n  TRACE_KIND_TOOL = 2;\n  TRACE_KIND_ROUTE = 3;\n  TRACE_KIND_LOG = 4;\n  TRACE_KIND_TOKEN = 5;\n  TRACE_KIND_RESULT = 6;\n}\n\n// Status of trace unit\nenum TraceStatus {\n  TRACE_STATUS_UNSPECIFIED = 0;\n  TRACE_STATUS_STARTED = 1;\n  TRACE_STATUS_SUCCEEDED = 2;\n  TRACE_STATUS_FAILED = 3;\n  TRACE_STATUS_SKIPPED = 4;\n}\n\n"