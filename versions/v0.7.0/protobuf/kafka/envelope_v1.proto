"// Universal Message Envelope (EnvelopeV1) for Familiar Kafka communication\n//\n// A single envelope type for ALL Kafka communication in the Familiar system.\n// This follows the \"message envelope\" design pattern where:\n//\n// - **Standardized Metadata**: Common fields are present across all messages\n// - **Decoupling**: System metadata is separated from domain-specific payloads\n// - **Cross-Cutting Concerns**: Routing, filtering, security operate on envelope\n// - **Schema Evolution**: Envelope evolves independently from payloads\n//\n// Kafka Headers (duplicated for routing WITHOUT deserializing):\n// | Header | Purpose | Example |\n// |--------|---------|---------|\n// | `message_type` | Routing | `familiar.course.command.start` |\n// | `schema_id` | Schema Registry | `1832` |\n// | `correlation_id` | Trace correlation | `crs_01JF...` |\n// | `content_type` | Format hint | `application/x-protobuf` |\n\nsyntax = \"proto3\";\n\npackage familiar.kafka;\n\nimport \"payload.proto\";\n\n// Schema version for envelope evolution\n// const ENVELOPE_VERSION = 1;\n\n// =============================================================================\n// EnvelopeV1 - Universal Message Envelope\n// =============================================================================\n\n// Universal message envelope for all Kafka communication\n//\n// This is the SINGLE envelope type used for commands, events, and traces.\n// Payload type is distinguished by the discriminated union.\n//\n// Key Design Decisions:\n// - `message_id`: ULID for natural time-ordering and uniqueness\n// - `message_type`: Dot-notation for routing (e.g., `familiar.course.command.start`)\n// - `correlation_id`: Often equals `course_id` for course workflows\n// - `causation_id`: Points to upstream message that caused this one\n//\n// Kafka Record Mapping:\n// - Key: `{tenant_id}:{correlation_id}` for partition affinity\n// - Value: Serialized EnvelopeV1 (Protobuf)\n// - Headers: `message_type`, `correlation_id`, `schema_id`, `content_type`\nmessage EnvelopeV1 {\n  // === Identity ===\n  // Unique message ID (ULID for natural ordering)\n  string message_id = 1;\n  // Message type for routing (e.g., \"familiar.course.command.start\")\n  string message_type = 2;\n  // When this message was created (RFC3339 string for serde compatibility)\n  string occurred_at = 3;\n\n  // === Context ===\n  // Tenant (family) context - UUID as string\n  string tenant_id = 4;\n  // Thread context (conversation) - optional\n  optional string thread_id = 5;\n  // Course context (correlation_id for course workflows) - optional\n  optional string course_id = 6;\n  // User who initiated this message - UUID as string\n  string user_id = 7;\n\n  // === Tracing ===\n  // Correlation ID (ties together workflow, often == course_id)\n  string correlation_id = 8;\n  // Causation ID (upstream message that caused this)\n  optional string causation_id = 9;\n\n  // === Producer ===\n  // Information about the message producer\n  ProducerInfo producer = 10;\n\n  // === Schema ===\n  // Schema information for validation\n  SchemaInfo schema = 11;\n\n  // === Payload ===\n  // The actual message payload (discriminated union)\n  Payload payload = 12;\n}\n\n// Producer metadata for tracing and debugging\nmessage ProducerInfo {\n  // Service name (e.g., \"familiar-api\", \"familiar-worker\")\n  string service = 1;\n  // Instance identifier (e.g., pod name, hostname)\n  string instance = 2;\n  // Build version (git hash, version tag)\n  optional string build = 3;\n}\n\n// Schema metadata for validation and evolution\nmessage SchemaInfo {\n  // Serialization format (\"json\", \"protobuf\", \"avro\")\n  string format = 1;\n  // Schema subject in Schema Registry\n  string subject = 2;\n  // Schema version\n  uint32 version = 3;\n}\n\n"